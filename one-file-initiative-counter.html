<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Initiative</title>
  </head>
  <body onload="createTable()">
    <!-- Initiative Counter-->
    <div class="initCounter">
      <button class="button" onclick="reset()">Reset</button>
      <!-- display -->
      <input type="text" class="display" disabled />
      <!-- Button to iterate through turns -->
      <button class="button" onclick="advanceTurn()">Next Turn</button>
    </div>

    <table id="table" class="fixed_headers">
      <thead>
        <tr>
          <th><input type="button" value="Add New Row" class="button" onclick="addRow()" /></th>
          <th>INITIATIVE</th>
          <th>NAME</th>
          <th>HP</th>
          <th>CONDITIONS</th>
        </tr>
      </thead>
      <tbody id="tBody"></tbody>
    </table>
    <!--the container to add the table.-->
  </body>
</html>

<script>
// select the <input type="text" class="display" disabled> element
const display = document.querySelector(".display");
class Row {
  constructor(init, name, hp, conditions, hasATurn, id) {
    this.init = init || 0;
    this.name = name || "";
    this.hp = hp || "";
    this.conditions = conditions || "";
    this.hasATurn = hasATurn || false;
    this.id = id || Date.now().toString(36);
  }

  render() {
    const { id } = this;
    const tBody = document.getElementById("tBody");
    const tRow = document.createElement("tr");

    // Change background if has a turn
    if (this.hasATurn) {
      tRow.style.backgroundColor = "#78c986";
    }

    // Update the values if changed
    tRow.addEventListener("change", (event) => {
      this[event.target.name] = event.target.value;
      localStorage.setItem("table", JSON.stringify(rows));
    });

    // Table headers.
    const props = ["Remove", "init", "name", "hp", "conditions"];
    // Insert cells
    props.forEach((prop, index) => this._addCell(tRow, prop, index, id));

    tBody.appendChild(tRow);
  }

  _addCell(row, prop, cellIndex, rowId) {
    const cell = row.insertCell();
    const input = document.createElement("input");

    input.setAttribute("name", prop);
    input.setAttribute("value", this[prop]);
    input.setAttribute("type", "text");

    // first cell
    if (cellIndex === 0) {
      input.setAttribute("value", prop);
      input.setAttribute("type", "button");
      input.setAttribute("class", "button");
      // add button's 'onclick' event.
      input.setAttribute("onclick", `removeRow("${rowId}")`);
    }

    // second cell
    else if (cellIndex === 1) {
      input.setAttribute("type", "number");
      input.setAttribute("onBlur", "sortTable()");
      input.setAttribute("autocomplete", "off");
    }

    cell.appendChild(input);
  }
}

let rows = [];
let round = 1;

function createTable() {
  const storedRound = localStorage.getItem("round");
  if (storedRound) round = Number(localStorage.getItem("round"));
  updateRound();

  const storedTable = localStorage.getItem("table");
  if (storedTable) {
    table = JSON.parse(storedTable);

    rows = table.map((row) => {
      return new Row(...Object.values(row));
    });
    renderAll();
    return;
  }
  addRow();
  renderAll();
}
function addRow() {
  rows.push(new Row());
  renderAll();
}

function removeRow(rowId) {
  rows = rows.filter(function (row) {
    return row.id !== rowId;
  });
  renderAll();
}

function sortTable() {
  rows.sort((a, b) => b.init - a.init);
  renderAll();
}

function advanceTurn() {
  const lastTurnIndex = rows.findIndex((row) => row.hasATurn);
  const isLast = lastTurnIndex >= rows.length - 1;

  // deal with edge case (none hasATurn )
  if (lastTurnIndex < 0) {
    rows[0].hasATurn = true;
    renderAll();

    return;
  }
  // remove previous hasATurn if any
  rows[lastTurnIndex].hasATurn = false;

  // deal with edge case (last of the table)
  if (isLast) {
    rows[0].hasATurn = true;
    round++;

    updateRound();
    renderAll();

    return;
  }
  // advance the turn
  rows[lastTurnIndex + 1].hasATurn = true;
  renderAll();
}

function updateRound() {
  localStorage.setItem("round", round);
  display.value = "Round " + round.toString();
}

function reset() {
  rows.forEach((row) => (row.hasATurn = false));
  round = 1;
  renderAll();
  updateRound();
}

function renderAll() {
  // TODO: Bad practice, this should be a different function
  // store first
  localStorage.setItem("table", JSON.stringify(rows));

  document.getElementById("tBody").innerHTML = "";
  rows.forEach((row) => {
    row.render();
    return;
  });
}
</script>
<style>
body {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  background-color: #222831;
  font-family: sans-serif;
}
/* width */
::-webkit-scrollbar {
  width: 13px;
}

/* Track */
::-webkit-scrollbar-track {
  background: #f1f1f1;
}

/* Handle */
::-webkit-scrollbar-thumb {
  background: #888;
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: #555;
}

.button {
  background-color: #222831;
  border: none;
  color: white;
  padding: 10px 25px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  cursor: pointer;
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
  border-bottom-left-radius: 7px;
  border-bottom-right-radius: 7px;
}

/* display */
.initCounter {
  width: 100%;
  height: 80px;
  border: none;
  box-sizing: border-box;
  padding: 10px;
  font-size: 2rem;
  background-color: #f1c544;
  color: #000;
  text-align: right;
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
}

table {
  table-layout: fixed;

  height: 40%;
  left: 10%;
  margin: 20px auto;
  color: #000;
}

table th,
table td {
  padding: 5px;
  text-align: center;
}
.fixed_headers td:nth-child(1),
.fixed_headers th:nth-child(1) {
  min-width: 160px;
}
.fixed_headers td:nth-child(2),
.fixed_headers th:nth-child(2) {
  min-width: 180px;
}
.fixed_headers td:nth-child(3),
.fixed_headers th:nth-child(3) {
  min-width: 240px;
}

.fixed_headers td:nth-child(4),
.fixed_headers th:nth-child(4) {
  min-width: 200px;
}

.fixed_headers td:nth-child(5),
.fixed_headers th:nth-child(5) {
  min-width: 200px;
}

.fixed_headers thead {
  background-color: #222831;
}

thead th {
  background: #f1c544;
  color: #000;
  font-family: "Lato", sans-serif;
  font-size: 16px;
  font-weight: 100;
  letter-spacing: 2px;
  text-transform: uppercase;
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
}
.fixed_headers thead tr {
  display: block;
  position: relative;
}

.fixed_headers tbody {
  display: block;
  width: 100%;
  height: 600px;
}

tbody tr {
  background: #f4f7f8;
  border: 2px solid #222831;
}

th,
td {
  font-family: "Lato", sans-serif;
  font-weight: 400;
  font-size: 18px;
}
.old_ie_wrapper {
  height: 300px;
  width: 750px;
  overflow-x: hidden;
  overflow-y: auto;
}
.old_ie_wrapper tbody {
  height: auto;
}
</style>
